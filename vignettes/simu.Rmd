---
title: "simu"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{simu}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
# remotes::install_github("PengSU517/robcovsel")
library(robcovsel)
library(doParallel)
#detectCores()
#registerDoParallel(cores=8)
#getDoParWorkers()
cs = makeCluster(8)
registerDoParallel(cs)
#stopCluster(cs)
```

```{r}
###### settings
{
  ns = c(100)
  ps = c(200)
  es = c(0.02, 0.05, 0.1)
  gammas = (0:5)*2
}


##### methods
lassof = function(x,y){covlasso(x,y,cor.method = "pearson",scale.method = "sd", ada = F)$betahat_opt}
sparseShootingSf = function(x,y){sparseshooting(x,y, maxIteration = 20)$coef[-1]}
sltsf = function(x,y){fit = sparseLTS(x,y);fit$coefficients[-1]}
gausslassof = function(x,y){covlasso(x,y,cor.method = "gaussrank", ada = T)$betahat_opt}
nearpdafa = function(x,y){covlasso(x, y, ada = T)$betahat_opt}

mtds = list(Lasso = lassof, 
            sLTS = sltsf, 
            sShootingS = sparseShootingSf,
            ALGR = gausslassof,
            ALRP = nearpdafa
      )


#### measurements
{
  msef<-function(betahat){mean(((betahat-beta))^2)}
  mse5f<-function(betahat){mean(((betahat-beta)[1:5])^2)}
  tpf<-function(betahat){sum((as.logical(betahat)==as.logical(beta))[1:5])}
  tnf<-function(betahat){sum((as.logical(betahat)==as.logical(beta))[-(1:5)])}
}


```



```{r}
system.time({
  result = foreach(m = 1:8, .combine = "rbind", 
                   .packages = c("MASS", "lars", "robustbase", "robustHD","robcovsel", "shootings"))%:%
    
    foreach(n = ns, .combine = "rbind")%:%
    foreach(p = ps, .combine = "rbind")%:%
    foreach(e = es, .combine = "rbind")%:%
    foreach(mtd = 1:length(mtds), .combine = "rbind")%:%
    foreach(gamma = gammas,.combine = "rbind")%dopar%{
      
      {
        {
          r = 0.5 
          mu = rep(0,p)
          sigma = diag(rep(1^2,p))
          for (i in 1:p) {for (j in 1:p) {
            if (abs(i-j)!=0)sigma[i,j] = sqrt(sigma[i,i]*sigma[j,j])*r^abs(i-j)}}
          beta = c(c(2,1,2,1,2),rep(0,p-5))
        }
        {
          xr = MASS::mvrnorm(n,mu,sigma)
          error = rnorm(n,0,0.5)###the noise proportion is too large
          y = xr%*%beta + error
          bi = apply(matrix(0, nrow = n, ncol = p), 2, 
                     function(xvec) {xvec[sample(x = 1:n, size = e*n)] = 1; return(xvec)})
  
          outlier = matrix(rnorm(n = n*p, mean = gamma, sd = 1),nrow = n,ncol=p)
          x = xr*(1-bi) + bi*outlier
        }
      }
      
      {
        betahat = mtds[[mtd]](x,y)
        mse = msef(betahat)
        mse5 = mse5f(betahat)
        tp = tpf(betahat)
        tn = tnf(betahat)
        rst = c(n = n, p = p, e = e, gamma = gamma, mtd = names(mtds)[mtd],  
                           mse = mse, mse5 = mse5, tp = tp, fp = (p-5)-tn)
      }
      rst
    }
})
```



```{r}

result = as.data.frame(result)
readr::write_csv(test, "result_random_predictors_200.csv")

```


```{r analysis}
library(tidyverse)
library(gridExtra)
library(grid)


####### 20 predictors
result = as.data.frame(read_csv("result_random_predictors_20.csv")) 
glimpse(result)

summary = result %>% group_by(n,p,e,gamma,mtd) %>% summarise(
  MSE = mean(mse, na.rm = T),MSE5 = mean(mse5, na.rm = T),TPR = mean(tp/5, na.rm = T),FPR = mean(fp/15, na.rm = T))
summary = summary %>% mutate(mtd = factor(mtd, levels = c("Lasso", "sLTS", "sShootingS", "ALRP", "ALGR")))
summary$e = factor(summary$e, labels = c("e = 2%","e = 5%","e = 10%"))
glimpse(summary)


p1 = ggplot(data = summary, aes(x = gamma,y = MSE, color = mtd ))+geom_line()+geom_point()+facet_wrap(~e) +
  scale_x_continuous(breaks=seq(0,12,2)) +
  labs(fill = "", x = expression(gamma*": magnitude of outlyingness"))+ 
  guides(fill = guide_legend(title = "Thresholds")) +
  theme_light() +
  theme(text= element_text(size=20))

p2 = ggplot(data = summary, aes(x = gamma,y = TPR, color = mtd ))+geom_line()+geom_point()+ facet_wrap(~e) +
  scale_x_continuous(breaks=seq(0,12,2)) +
  ylim(0,1) +
  labs(fill = "", x = "")+ 
  guides(fill = guide_legend(title = "Thresholds")) +
  theme_light() +
  theme(text= element_text(size=20))

p3 = ggplot(data = summary, aes(x = gamma,y = FPR, color = mtd ))+geom_line()+geom_point()+ facet_wrap(~e) +
  scale_x_continuous(breaks=seq(0,12,2)) +
  ylim(0,1) +
  labs(fill = "", x = "")+ 
  guides(fill = guide_legend(title = "Thresholds")) +
  theme_light() +
  theme(text= element_text(size=20))


grid_arrange_shared_legend <- function(..., ncol = length(list(...)), nrow = 1, position = c("bottom", "right")) {
  
  plots <- list(...)
  position <- match.arg(position)
  g <- ggplotGrob(plots[[1]] + theme(legend.position = position))$grobs
  legend <- g[[which(sapply(g, function(x) x$name) == "guide-box")]]
  lheight <- sum(legend$height)
  lwidth <- sum(legend$width)
  gl <- lapply(plots, function(x) x + theme(legend.position="none"))
  gl <- c(gl, ncol = ncol, nrow = nrow)
  
  combined <- switch(position,
                     "bottom" = arrangeGrob(do.call(arrangeGrob, gl),
                                            legend,
                                            ncol = 1,
                                            heights = unit.c(unit(1, "npc") - lheight, lheight)),
                     "right" = arrangeGrob(do.call(arrangeGrob, gl),
                                           legend,
                                           ncol = 2,
                                           widths = unit.c(unit(1, "npc") - lwidth, lwidth)))
  
  grid.newpage()
  grid.draw(combined)
  
  # return gtable invisibly
  invisible(combined)
  
}


pp20 = grid_arrange_shared_legend(p2,p3,p1,nrow = 3, ncol = 1, position = "bottom")
pp20

ggsave("plots_20.eps", plot = pp20, width = 10,height = 8)

```










   
   

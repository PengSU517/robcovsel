---
title: "simu"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{simu}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
#########system settings
#remotes::install_github("PengSU517/robcovsel")
#remotes::install_github("PengSU517/shootings") !!!!!!!!!!!!!!
#this shootings package is constructed based on ineswilms/sparse-shooting-S
#rm(list = ls()) # clean slate
#setwd(dirname(rstudioapi::getSourceEditorContext()$path))
```


```{r analysis,  fig.width=10, fig.height=12}
library(tidyverse)
library(gridExtra)
library(grid)
library(robcovsel)
load("result_simu_p20.RData")

result1 = as.data.frame(t(as.data.frame(result)))
result1 = result1[complete.cases(result1),]

glimpse(result1)
result1 = result1 %>% mutate(tp = as.numeric(tp), fp = as.numeric(fp), gamma = as.numeric(gamma), p = as.numeric(p), fn = 5-tp, tn = p-5-fp, f1 = tp/(tp + 0.5*(fp+fn)), f1 = tp/(tp+0.5*(fp+fn)))
#mcc = ((tp*tn + fp*fn)/sqrt((tp+fp)*(tp+fn)*(tn+fp)*(tn+fn)))

summary = result1 %>% group_by(n,p,e,r,gamma,mtd) %>% summarise(
  TPR = mean(tp/5, na.rm = T),FPR = mean(fp/(p-5), na.rm = T), F1 = mean(f1))%>%ungroup()
summary = summary %>% mutate(Method = factor(mtd, levels = c("ALRP",  "ALGR", "LRP",  "LGR", "sShootingS", "sLTS", "aLasso", "Lasso")))
summary$e = factor(summary$e, labels = c("e = 2%","e = 5%","e = 10%"))
summary$r = factor(summary$r, labels = c("r = 0.5","r = 0.7","r = 0.9"))
glimpse(summary)

```


```{r}
p1 = ggplot(data = summary, aes(x = gamma,y = F1, color = Method ))+
  geom_line()+geom_point()+facet_grid(r~e) +
  scale_x_continuous(breaks=seq(0,12,2)) +
  labs(fill = "", x = expression(gamma*": magnitude of outlyingness"), y = expression(F[1]))+ 
  guides(fill = guide_legend(title = "Thresholds")) +
  theme_light() +
  theme(text= element_text(size=20))

p2 = ggplot(data = summary, aes(x = gamma,y = TPR, color = Method ))+
  geom_line()+geom_point()+facet_grid(r~e) +
  scale_x_continuous(breaks=seq(0,12,2)) +
  ylim(0,1) +
  labs(fill = "", x = "")+ 
  guides(fill = guide_legend(title = "Thresholds")) +
  theme_light() +
  theme(text= element_text(size=20))

p3 = ggplot(data = summary, aes(x = gamma,y = FPR, color = Method ))+
  geom_line()+geom_point()+facet_grid(r~e) +
  scale_x_continuous(breaks=seq(0,12,2)) +
  ylim(0,1) +
  labs(fill = "", x = "")+ 
  guides(fill = guide_legend(title = "Thresholds")) +
  theme_light() +
  theme(text= element_text(size=20))

```


```{r  fig.width=10, fig.height=10}
p1

p2

p3

ggsave("plots_20_f1.eps", plot = p1, width = 10,height = 8)

ggsave("plots_20_tpr.eps", plot = p2, width = 10,height = 8)

ggsave("plots_20_fpr.eps", plot = p3, width = 10,height = 8)
```











```{r}
grid_arrange_shared_legend <- function(..., ncol = length(list(...)), nrow = 1, position = c("bottom", "right")) {
  
  plots <- list(...)
  position <- match.arg(position)
  g <- ggplotGrob(plots[[1]] + theme(legend.position = position))$grobs
  legend <- g[[which(sapply(g, function(x) x$name) == "guide-box")]]
  lheight <- sum(legend$height)
  lwidth <- sum(legend$width)
  gl <- lapply(plots, function(x) x + theme(legend.position="none"))
  gl <- c(gl, ncol = ncol, nrow = nrow)
  
  combined <- switch(position,
                     "bottom" = arrangeGrob(do.call(arrangeGrob, gl),
                                            legend,
                                            ncol = 1,
                                            heights = unit.c(unit(1, "npc") - lheight, lheight)),
                     "right" = arrangeGrob(do.call(arrangeGrob, gl),
                                           legend,
                                           ncol = 2,
                                           widths = unit.c(unit(1, "npc") - lwidth, lwidth)))
  
  grid.newpage()
  grid.draw(combined)
  # return gtable invisibly
  invisible(combined)
  
}


pp = grid_arrange_shared_legend(p3,p4,p1, nrow = 3, ncol = 1, position = "bottom")
#ggsave("plots_200.eps", plot = pp, width = 10,height = 8)
```




   
   
